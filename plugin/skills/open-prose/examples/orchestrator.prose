# Autonomous Multi-Agent Orchestration System
# A continuously running system that manages specialized subagents

# Import skills for various capabilities
import "web-search" from "github:anthropic/skills"
import "code-executor" from "github:anthropic/skills"
import "file-manager" from "github:anthropic/skills"
import "notification" from "github:anthropic/skills"
import "scheduler" from "./local-skills/scheduler"

# Top-level orchestrator - the brain of the system
agent orchestrator:
  model: opus
  prompt: """
    You are the central orchestrator managing a complex autonomous system.
    Your responsibilities:
    - Monitor system health and task queues
    - Delegate work to specialized agents
    - Handle escalations and make strategic decisions
    - Ensure graceful degradation when components fail
    - Maintain system coherence across all operations
  """
  permissions:
    read: ["**/*"]
    write: ["logs/", "state/"]
    bash: prompt
    network: allow

# Specialized agents for different domains
agent researcher:
  model: sonnet
  prompt: "You gather information, analyze sources, and synthesize findings into actionable insights."
  skills: ["web-search"]
  permissions:
    read: ["*.md", "*.txt", "research/"]
    bash: deny
    network: allow

agent developer:
  model: sonnet
  prompt: "You write, review, and refactor code following best practices."
  skills: ["code-executor", "file-manager"]
  permissions:
    read: ["src/", "tests/"]
    write: ["src/", "tests/"]
    bash: prompt

agent analyst:
  model: opus
  prompt: "You perform deep analysis, identify patterns, and provide strategic recommendations."
  permissions:
    read: ["data/", "reports/"]
    write: ["reports/"]
    bash: deny

agent monitor:
  model: haiku
  prompt: "You quickly check system health, resource usage, and alert on anomalies."
  skills: ["notification"]
  permissions:
    read: ["logs/", "metrics/"]
    bash: deny

agent executor:
  model: sonnet
  prompt: "You execute approved tasks, run scripts, and manage deployments safely."
  skills: ["code-executor", "scheduler"]
  permissions:
    read: ["scripts/", "config/"]
    execute: ["scripts/*.sh"]
    bash: prompt

# Reusable workflow blocks
block health-check:
  parallel:
    system = session: monitor
      prompt: "Check system resource utilization and health metrics"
    queue = session: monitor
      prompt: "Check pending task queue depth and priorities"
    alerts = session: monitor
      prompt: "Check for any unacknowledged alerts or warnings"

  session: orchestrator
    prompt: "Synthesize health status and determine if intervention needed"
    context: { system, queue, alerts }

block research-cycle(topic):
  let findings = session: researcher
    prompt: "Research {topic} - gather relevant information from multiple sources"

  let analysis = session: analyst
    prompt: "Analyze research findings and identify key insights"
    context: findings

  session: orchestrator
    prompt: "Review analysis and determine next actions"
    context: analysis

block development-cycle(task):
  let plan = session: developer
    prompt: "Create implementation plan for: {task}"

  let code = session: developer
    prompt: "Implement the planned changes"
    context: plan

  let review = session: developer
    prompt: "Self-review the implementation for issues"
    context: code

  if **review identified issues that need fixing**:
    session: developer
      prompt: "Fix identified issues"
      context: review

block error-recovery(error):
  session: orchestrator
    prompt: "Analyze error and determine recovery strategy"
    context: error

  choice **the appropriate recovery action**:
    option "Retry":
      session: executor
        prompt: "Retry the failed operation with adjusted parameters"
    option "Escalate":
      session: monitor
        prompt: "Send escalation notification to human operators"
        context: error
    option "Graceful Degradation":
      session: orchestrator
        prompt: "Disable affected component and route around failure"
    option "System Pause":
      session: monitor
        prompt: "Pause non-critical operations and alert operators"

# Main orchestration loop - runs forever
loop:
  try:
    # Phase 1: Health check
    do health-check

    # Phase 2: Gather system state and pending work
    let state = session: orchestrator
      prompt: """
        Assess current system state:
        - What tasks are pending?
        - What is the current priority?
        - Are there any blocked items?
        - What resources are available?
      """

    # Phase 3: Intelligent task dispatch based on current state
    choice **the highest priority action based on system state**:
      option "Research Task":
        let topic = session: orchestrator
          prompt: "Identify the research topic from pending tasks"
          context: state
        do research-cycle(topic)

      option "Development Task":
        let task = session: orchestrator
          prompt: "Identify the development task to execute"
          context: state
        do development-cycle(task)

      option "Execution Task":
        session: executor
          prompt: "Execute the next approved task from the queue"
          context: state
          retry: 3
          backoff: "exponential"

      option "Analysis Task":
        parallel:
          metrics = session: analyst
            prompt: "Analyze recent system metrics for trends"
          patterns = session: analyst
            prompt: "Identify patterns in task completion and failures"

        session: orchestrator
          prompt: "Review analysis and update system strategy"
          context: { metrics, patterns }

      option "Maintenance":
        parallel (on-fail: "continue"):
          session: executor
            prompt: "Run scheduled maintenance tasks"
          session: monitor
            prompt: "Archive old logs and clean temporary files"

        session: orchestrator
          prompt: "Log maintenance completion status"

      option "Idle":
        session: monitor
          prompt: "System idle - perform light monitoring sweep"

    # Phase 4: Learning and adaptation
    if **significant events occurred this cycle that warrant learning**:
      session: orchestrator
        prompt: """
          Reflect on this cycle's outcomes:
          - What worked well?
          - What could be improved?
          - Should any agent configurations be adjusted?
          - Are there new patterns to incorporate?
        """

  catch as err:
    do error-recovery(err)

  finally:
    # Always log cycle completion
    session: monitor
      prompt: "Log orchestration cycle completion with summary metrics"
